<!DOCTYPE html>
<html><head>
  <title>Using seed to explore APIs</title>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../../css/theme.css"/>
  
  <link rel="stylesheet" href="../../../css/syntax.css"/>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-56296045-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  <meta property="og:title" content="Using seed to explore APIs" />
<meta property="og:description" content="I&rsquo;ve been working to update seed, which is HappyFunCorp&rsquo;s app generator to make it easy to kick off MVPs. Check out the website for more information. One of the things that I&rsquo;ve started to do is to seperate out the dependancies more, and being tutorials on how to use each of the different features. After I link to that stuff, let&rsquo;s walk through a way to combine different techniques we&rsquo;ve discussed together." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://willschenk.com/articles/2015/using-seed-to-explore/" /><meta property="article:published_time" content="2015-09-17T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2015-09-17T00:00:00&#43;00:00"/>

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Using seed to explore APIs"/>
<meta name="twitter:description" content="I&rsquo;ve been working to update seed, which is HappyFunCorp&rsquo;s app generator to make it easy to kick off MVPs. Check out the website for more information. One of the things that I&rsquo;ve started to do is to seperate out the dependancies more, and being tutorials on how to use each of the different features. After I link to that stuff, let&rsquo;s walk through a way to combine different techniques we&rsquo;ve discussed together."/>
<meta name="twitter:site" content="@wschenk"/>


  <style>
    .article p, .article ul, .article ol, .article table {
      max-width: 45em;
    }

    article.article p:first-child, .article blockquote {
      font-size: 1.25em;
      font-weight: 300;
      max-width: 36em;  
    }
  </style>
</head>
<body><nav class="container my-5">
  <h1 class="pt-5 display-3"><a class="text-dark" href="../../../">Will Schenk</a></h1>
  <p>
    
      <a class="text-dark h4 mr-3 font-weight-light" href="../../../articles/" title="">Articles</a>
    
      <a class="text-dark h4 mr-3 font-weight-light" href="../../../contact" title="">Contact</a>
    
      <a class="text-dark h4 mr-3 font-weight-light" href="../../../tags/" title="">Tags</a>
    
    <a href="../../../feed.xml" class="mr-3 h4 text-light"><img src="../../../img/rss.svg" alt="rss" height="20" width="20"/></a>
    
      <a href="https://twitter.com/@wschenk" class="mr-3 h4 text-light"><img src="../../../img/twitter.svg" alt="twitter" height="20" width="20"/></a>
    
    
      <a href="https://instagram.com/wschenk" class="mr-3 h4 text-light"><img src="../../../img/instagram.svg" alt="instagram" height="20" width="20"/></a>
    
    
      <a href="https://linkedin.com/in/will-schenk-420266" class="mr-3 h4 text-light"><img src="../../../img/linkedin.svg" alt="linkedin" height="20" width="20"/></a>
    
  </p>
</nav>

<div class="container">
  <h1 class="mt-5">Using seed to explore APIs</h1>

  
    <h2 class="font-weight-light font-italic mb-3">overview of what we&rsquo;re working on and how to explore apis</h2>
  

  <p class="text-muted mt-3">
    <a class="text-muted" href="https://willschenk.com/articles/2015/using-seed-to-explore/">Published September 17, 2015</a>

    
      <a class="text-muted" href="../../../tags/happy_seed">#happy_seed</a>
    
      <a class="text-muted" href="../../../tags/rails">#rails</a>
    
      <a class="text-muted" href="../../../tags/howto">#howto</a>
    
      <a class="text-muted" href="../../../tags/github">#github</a>
    
      <a class="text-muted" href="../../../tags/rake">#rake</a>
    
  </p>

  

  <article class="article mt-5">
    

<p>I&rsquo;ve been working to update seed, which is HappyFunCorp&rsquo;s app generator to make it easy to kick off MVPs.  Check out the website for more information.  One of the things that I&rsquo;ve started to do is to seperate out the dependancies more, and being tutorials on how to use each of the different features.  After I link to that stuff, let&rsquo;s walk through a way to combine different techniques we&rsquo;ve discussed together.</p>

<ul>
<li>Check out <a href="http://seed.happyfuncorp.com">the site</a></li>
<li>Or watch the video:</li>
</ul>

<div class="embed-responsive embed-responsive-16by9">
  <iframe src="https://www.youtube.com/embed/hCsPDaKHw6I?rel=0" allowfullscreen></iframe>
</div>

<h2 id="the-basic-process">The basic process</h2>

<ol>
<li>Get access to the API.</li>
<li>Open up a console and start playing with commands.</li>
<li>Start storing the data locally once we need to get more.</li>
<li>Play around with the data.</li>
<li>Design a UI around in.</li>
<li>Refactor the test &ldquo;scripts&rdquo; into ruby classes that fit that UI.</li>
</ol>

<h2 id="using-seed-oauth-and-rake-to-explore-github-data">Using Seed, OAuth, and Rake to explore github data</h2>

<p>What I want to do is to look at all of the <code>Gemfile</code>s for all of our projects, and see which gems are the most popular, which versions we are using, and if we can develop some more expertise around it.  But first, I want to get the data.</p>

<p>I could go to each of the repos in github, but there are well over a hundred so that doesn&rsquo;t work.  Github has an API, which is great, but I need oauth2 to access it.  Let&rsquo;s get going.</p>

<h2 id="creating-a-github-application">Creating a github application</h2>

<p>The first step is to make sure you have a github application.</p>

<ol>
<li>Go to <a href="https://github.com/settings/developers">developer applications</a></li>
<li>Click <em>Register New Application</em></li>
<li>Enter in <code>http://localhost:3000/users/auth/github/callback</code> as the callback URL.</li>
<li>Fill in whatever else.</li>
<li><em>Resister the Application</em></li>
</ol>

<p>At this point you should have the <em>Client ID</em> and the <em>Client Secret</em>.</p>

<h2 id="create-a-seed-defaults-file">Create a seed_defaults file</h2>

<p>Once I create a remote app, I like to put the credentials into the <code>~/.seed_defaults</code> file.  This will make it so the next time I generate a seed app, these are the default credentials that are used.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">GITHUB_APP_ID</span><span class="o">=</span>replace with client id
<span class="nv">GITHUB_APP_SECRET</span><span class="o">=</span>replace with client secret</code></pre></div>
<h2 id="generate-the-app">Generate the app</h2>

<p>If you haven&rsquo;t installed <a href="http://seed.happyfuncorp.com">happy_seed</a> yet, do so now by typing <code>gem install happy_seed</code>.</p>

<p>Then generate the app:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ happy_seed rails project_stats</code></pre></div>
<p>Now it&rsquo;s going to install things.  Inititally, just say no to everything.  Once it&rsquo;s done, install the github generator:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ <span class="nb">cd</span> project_status
$ rails g happy_seed:github</code></pre></div>
<p>That will do its thing.  Then we need to create the database and get going:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ rake db:migrate</code></pre></div>
<h2 id="ask-for-more-scope">Ask for more scope</h2>

<p>When the <em>github</em> generator is run, it configures the oauth scope that it requests in <code>config/initializers/devise.rb</code>.  We need to ask for a bit more permissions, so open up that file and change the scope requested to be <code>&quot;user,repo,read:org&quot;</code>, so:</p>
<div class="highlight"><pre class="chroma"><code class="language-vash" data-lang="vash">config.omniauth :github, ENV[&#39;GITHUB_APP_ID&#39;], ENV[&#39;GITHUB_APP_SECRET&#39;], scope: &#34;user,repo,read:org&#34;</code></pre></div>
<p>Now lets start the server and see what&rsquo;s up:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ rails s</code></pre></div>
<ol>
<li>Point your browser to <a href="http://localhost:3000">http://localhost:3000</a></li>
<li>Select &ldquo;Sign up&rdquo; from the &ldquo;Account&rdquo; menu.</li>
<li>Press &ldquo;Sign in with Github&rdquo;</li>
<li>You should be bounced to github and you have to accept.</li>
<li>You should be back on localhost with the message <code>Successfully authenticated from Github account.</code></li>
</ol>

<h2 id="lets-play">Lets play</h2>

<ol>
<li><del>Get access to the API.</del></li>
<li>Open up a console and start playing with commands.</li>
<li>Start storing the data locally once we need to get more.</li>
<li>Play around with the data.</li>
<li>Design a UI around in.</li>
<li>Refactor the test &ldquo;scripts&rdquo; into ruby classes that fit that UI.</li>
</ol>

<p>Lets get in that console and see what we can do.  If you look at <code>app/models/user.rb</code> you can see that there&rsquo;s code to setup the github client, and we can access it like so:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ rails c
Loading development environment <span class="o">(</span>Rails <span class="m">4</span>.2.3<span class="o">)</span>
<span class="m">2</span>.2.1 :001 &gt; <span class="nv">gc</span> <span class="o">=</span> User.first.github_client
  User Load <span class="o">(</span><span class="m">0</span>.2ms<span class="o">)</span>  SELECT  <span class="s2">&#34;users&#34;</span>.* FROM <span class="s2">&#34;users&#34;</span>  ORDER BY <span class="s2">&#34;users&#34;</span>.<span class="s2">&#34;id&#34;</span> ASC LIMIT <span class="m">1</span>
  User Load <span class="o">(</span><span class="m">0</span>.2ms<span class="o">)</span>  SELECT  <span class="s2">&#34;users&#34;</span>.* FROM <span class="s2">&#34;users&#34;</span>  ORDER BY <span class="s2">&#34;users&#34;</span>.<span class="s2">&#34;id&#34;</span> ASC LIMIT <span class="m">1</span>
  Identity Load <span class="o">(</span><span class="m">0</span>.4ms<span class="o">)</span>  SELECT  <span class="s2">&#34;identities&#34;</span>.* FROM <span class="s2">&#34;identities&#34;</span> WHERE <span class="s2">&#34;identities&#34;</span>.<span class="s2">&#34;user_id&#34;</span> <span class="o">=</span> ? AND <span class="s2">&#34;identities&#34;</span>.<span class="s2">&#34;provider&#34;</span> <span class="o">=</span> ?  ORDER BY <span class="s2">&#34;identities&#34;</span>.<span class="s2">&#34;id&#34;</span> ASC LIMIT <span class="m">1</span>  <span class="o">[[</span><span class="s2">&#34;user_id&#34;</span>, <span class="m">1</span><span class="o">]</span>, <span class="o">[</span><span class="s2">&#34;provider&#34;</span>, <span class="s2">&#34;github&#34;</span><span class="o">]]</span>
  Identity Load <span class="o">(</span><span class="m">0</span>.4ms<span class="o">)</span>  SELECT  <span class="s2">&#34;identities&#34;</span>.* FROM <span class="s2">&#34;identities&#34;</span> WHERE <span class="s2">&#34;identities&#34;</span>.<span class="s2">&#34;user_id&#34;</span> <span class="o">=</span> ? AND <span class="s2">&#34;identities&#34;</span>.<span class="s2">&#34;provider&#34;</span> <span class="o">=</span> ?  ORDER BY <span class="s2">&#34;identities&#34;</span>.<span class="s2">&#34;id&#34;</span> ASC LIMIT <span class="m">1</span>  <span class="o">[[</span><span class="s2">&#34;user_id&#34;</span>, <span class="m">1</span><span class="o">]</span>, <span class="o">[</span><span class="s2">&#34;provider&#34;</span>, <span class="s2">&#34;github&#34;</span><span class="o">]]</span>
 <span class="o">=</span>&gt; <span class="c1">#&lt;Octokit::Client:0x007fe1f7bec7e8
</span><span class="c1"></span>
<span class="m">2</span>.2.1 :002 &gt; gc.org_repos<span class="o">(</span> <span class="s1">&#39;HappyFunCorp&#39;</span>, <span class="o">{</span>:type <span class="o">=</span>&gt; <span class="s1">&#39;private&#39;</span><span class="o">}</span> <span class="o">)</span>.count
 <span class="o">=</span>&gt; <span class="m">30</span></code></pre></div>
<p>Ok, now we can start figuring out what we need to do to get access to the data.  We have an authenticated user account, and we can start hitting the API.  I know for a fact that I have way more than 30 repos &ndash; I mean, seriously &ndash; so first thing is to figure out why that is and how to get more.  It&rsquo;s probably related to pagination.</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span> <span class="p">:</span><span class="mo">003</span> <span class="o">&gt;</span> <span class="n">gc</span><span class="o">.</span><span class="n">org_repos</span><span class="p">(</span> <span class="s1">&#39;HappyFunCorp&#39;</span><span class="p">,</span> <span class="p">{</span><span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">&#39;private&#39;</span><span class="p">,</span> <span class="ss">per_page</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span> <span class="p">)</span><span class="o">.</span><span class="n">count</span>
 <span class="o">=&gt;</span> <span class="mi">100</span></code></pre></div>
<p>OK, looking through the <a href="https://github.com/octokit/octokit.rb/issues/255">octokit issues</a> this can be dealt with by turning <code>auto_paginate: true</code> on when we load up the client.  So let&rsquo;s edit <code>app/models/user.rb</code> to do that:</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="vi">@github_client</span> <span class="o">||=</span> <span class="no">Octokit</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">access_token</span><span class="p">:</span> <span class="n">github</span><span class="o">.</span><span class="n">accesstoken</span><span class="p">,</span> <span class="ss">auto_paginate</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span></code></pre></div>
<p>Back to the console, do <code>reload!</code> and load up our client again.  Notice that I&rsquo;m making this a one liner, since we&rsquo;re going to be doing it over and over its nice to use the arrow keys.</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span> <span class="p">:</span><span class="mo">004</span> <span class="o">&gt;</span> <span class="n">reload!</span><span class="p">;</span> <span class="n">gc</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">github_client</span>
<span class="no">Reloading</span><span class="o">...</span>
  <span class="no">User</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span>  <span class="s2">&#34;users&#34;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&#34;users&#34;</span>  <span class="no">ORDER</span> <span class="no">BY</span> <span class="s2">&#34;users&#34;</span><span class="o">.</span><span class="s2">&#34;id&#34;</span> <span class="no">ASC</span> <span class="no">LIMIT</span> <span class="mi">1</span>
  <span class="no">User</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span>  <span class="s2">&#34;users&#34;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&#34;users&#34;</span>  <span class="no">ORDER</span> <span class="no">BY</span> <span class="s2">&#34;users&#34;</span><span class="o">.</span><span class="s2">&#34;id&#34;</span> <span class="no">ASC</span> <span class="no">LIMIT</span> <span class="mi">1</span>
  <span class="no">Identity</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span>  <span class="s2">&#34;identities&#34;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&#34;identities&#34;</span> <span class="no">WHERE</span> <span class="s2">&#34;identities&#34;</span><span class="o">.</span><span class="s2">&#34;user_id&#34;</span> <span class="o">=</span> <span class="p">?</span> <span class="no">AND</span> <span class="s2">&#34;identities&#34;</span><span class="o">.</span><span class="s2">&#34;provider&#34;</span> <span class="o">=</span> <span class="p">?</span>  <span class="no">ORDER</span> <span class="no">BY</span> <span class="s2">&#34;identities&#34;</span><span class="o">.</span><span class="s2">&#34;id&#34;</span> <span class="no">ASC</span> <span class="no">LIMIT</span> <span class="mi">1</span>  <span class="o">[[</span><span class="s2">&#34;user_id&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s2">&#34;provider&#34;</span><span class="p">,</span> <span class="s2">&#34;github&#34;</span><span class="o">]]</span>
  <span class="no">Identity</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span>  <span class="s2">&#34;identities&#34;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&#34;identities&#34;</span> <span class="no">WHERE</span> <span class="s2">&#34;identities&#34;</span><span class="o">.</span><span class="s2">&#34;user_id&#34;</span> <span class="o">=</span> <span class="p">?</span> <span class="no">AND</span> <span class="s2">&#34;identities&#34;</span><span class="o">.</span><span class="s2">&#34;provider&#34;</span> <span class="o">=</span> <span class="p">?</span>  <span class="no">ORDER</span> <span class="no">BY</span> <span class="s2">&#34;identities&#34;</span><span class="o">.</span><span class="s2">&#34;id&#34;</span> <span class="no">ASC</span> <span class="no">LIMIT</span> <span class="mi">1</span>  <span class="o">[[</span><span class="s2">&#34;user_id&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s2">&#34;provider&#34;</span><span class="p">,</span> <span class="s2">&#34;github&#34;</span><span class="o">]]</span>
 <span class="o">=&gt;</span> <span class="c1">#&lt;Octokit::Client:0x007fe1f7d986f0 @access_token=&#34;*.......</span>

<span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span> <span class="p">:</span><span class="mo">005</span> <span class="o">&gt;</span> <span class="n">gc</span><span class="o">.</span><span class="n">org_repos</span><span class="p">(</span> <span class="s1">&#39;HappyFunCorp&#39;</span><span class="p">,</span> <span class="p">{</span><span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">&#39;private&#39;</span><span class="p">}</span> <span class="p">)</span><span class="o">.</span><span class="n">count</span>
 <span class="o">=&gt;</span> <span class="mi">169</span></code></pre></div>
<p>OK, that looks better.  That will give us a list of all the repos, so now we just need to see how to get the contents of our file, and then we can put it all together.</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span> <span class="p">:</span><span class="mo">006</span> <span class="o">&gt;</span> <span class="n">repo</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">org_repos</span><span class="p">(</span> <span class="s1">&#39;HappyFunCorp&#39;</span><span class="p">,</span> <span class="p">{</span><span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">&#39;private&#39;</span><span class="p">}</span> <span class="p">)</span><span class="o">.</span><span class="n">first</span>
 <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:id</span><span class="o">=&gt;</span><span class="mi">988713</span><span class="p">,</span>
 <span class="ss">:name</span><span class="o">=&gt;</span><span class="s2">&#34;benchcoach&#34;</span><span class="p">,</span>
 <span class="ss">:full_name</span><span class="o">=&gt;</span><span class="s2">&#34;HappyFunCorp/benchcoach&#34;</span><span class="p">,</span>
 <span class="ss">:owner</span><span class="o">=&gt;</span>
 <span class="o">.....</span>

<span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span> <span class="p">:</span><span class="mo">007</span> <span class="o">&gt;</span> <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span>
 <span class="o">=&gt;</span> <span class="s2">&#34;HappyFunCorp/benchcoach&#34;</span>

<span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span> <span class="p">:</span><span class="mo">00</span><span class="mi">8</span> <span class="o">&gt;</span> <span class="n">content</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">contents</span> <span class="n">repo</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="ss">path</span><span class="p">:</span> <span class="s1">&#39;Gemfile&#39;</span>
 <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:name</span><span class="o">=&gt;</span><span class="s2">&#34;Gemfile&#34;</span><span class="p">,</span>
 <span class="ss">:path</span><span class="o">=&gt;</span><span class="s2">&#34;Gemfile&#34;</span><span class="p">,</span>
 <span class="ss">:sha</span><span class="o">=&gt;</span><span class="s2">&#34;1d67bb85e43adab5b68ecc0eb3a5304e6ee2588e&#34;</span><span class="p">,</span><span class="o">....</span></code></pre></div>
<p>Looking at this, we see that github returns the contents of the file base64 encoded.  I guess that makes sense, so if we want to print it out:</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span> <span class="p">:</span><span class="mo">00</span><span class="mi">9</span> <span class="o">&gt;</span> <span class="no">Base64</span><span class="o">.</span><span class="n">decode64</span> <span class="n">content</span><span class="o">.</span><span class="n">content</span></code></pre></div>
<h2 id="using-rake-to-pull-the-data-down">Using Rake to pull the data down</h2>

<ol>
<li><del>Get access to the API.</del></li>
<li><del>Open up a console and start playing with commands.</del></li>
<li>Start storing the data locally once we need to get more.</li>
<li>Play around with the data.</li>
<li>Design a UI around in.</li>
<li>Refactor the test &ldquo;scripts&rdquo; into ruby classes that fit that UI.</li>
</ol>

<p>Lets use rake to start managing the data.  We&rsquo;re going to be using some of the techniques that were outlined in the <a href="../../../using-rake-for-dataflow-programming-and-data-science/]">using rake for dataflow programming and data science</a> post.  First step is to create a <code>lib/tasks/github.rake</code> file that we&rsquo;re going to put our tasks.</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;fileutils&#39;</span>

<span class="n">file</span> <span class="s2">&#34;data/projects.json&#34;</span> <span class="k">do</span>
  <span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="o">[</span><span class="s2">&#34;environment&#34;</span><span class="o">].</span><span class="n">invoke</span>
  <span class="no">FileUtils</span><span class="o">.</span><span class="n">mkdir_p</span> <span class="s2">&#34;data&#34;</span>

  <span class="n">gc</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">github_client</span>

  <span class="n">data</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">org_repos</span><span class="p">(</span> <span class="s1">&#39;HappyFunCorp&#39;</span><span class="p">,</span> <span class="p">{</span><span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">&#39;private&#39;</span><span class="p">}</span> <span class="p">)</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
    <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="n">x</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">,</span>
      <span class="ss">full_name</span><span class="p">:</span> <span class="n">x</span><span class="o">[</span><span class="ss">:full_name</span><span class="o">]</span><span class="p">,</span>
      <span class="ss">url</span><span class="p">:</span> <span class="n">x</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span> <span class="s2">&#34;data/projects.json&#34;</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span> <span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">out</span><span class="o">|</span>
    <span class="n">out</span><span class="o">.</span><span class="n">puts</span> <span class="no">JSON</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>
<p><em>Be sure to change the <code>HappyFunCorp</code> to your organization, or use the <code>repos</code> call instead of the organization one.</em></p>

<p>Now lets run <code>rake data/projects.json</code>.  If you run it a second time, notice that rake returns imediately and doesn&rsquo;t hit the remote server.</p>

<ol>
<li>The <code>file</code> task only runs if the file doesn&rsquo;t exist.</li>
<li><code>Rake::Task[&quot;environment&quot;].invoke</code> is a way to ensure that a task as been run without forcing it to run.</li>
<li>The API calls are from our console experiments.</li>
<li>Just save it to a file.</li>
</ol>

<p>OK, now lets be able to loop over everything to load the files that we want.  First we define a method that lets us define a task to loop over all the entries in a JSON array, and then we&rsquo;ll call it with our block which loads up the contents.  (Add this to the end of the <code>github.rake</code> file)</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">for_each_elem</span><span class="p">(</span> <span class="nb">name</span><span class="p">,</span> <span class="n">file</span> <span class="p">)</span>
  <span class="n">task</span> <span class="nb">name</span> <span class="o">=&gt;</span> <span class="n">file</span> <span class="k">do</span>
    <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span> <span class="n">file</span> <span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">record</span><span class="o">|</span>
      <span class="k">yield</span> <span class="n">record</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">for_each_elem</span> <span class="s2">&#34;load_gemfiles&#34;</span><span class="p">,</span> <span class="s2">&#34;data/projects.json&#34;</span> <span class="k">do</span> <span class="o">|</span><span class="n">repo</span><span class="o">|</span>
  <span class="n">outfile</span> <span class="o">=</span> <span class="s2">&#34;data/gemfiles/</span><span class="si">#{</span><span class="n">repo</span><span class="o">[</span><span class="s1">&#39;name&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">.Gemfile.lock&#34;</span>
  <span class="no">FileUtils</span><span class="o">.</span><span class="n">mkdir_p</span> <span class="s2">&#34;data/gemfiles&#34;</span>

  <span class="n">file</span> <span class="n">outfile</span> <span class="k">do</span>
    <span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="o">[</span><span class="s2">&#34;environment&#34;</span><span class="o">].</span><span class="n">invoke</span>

    <span class="n">gc</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">github_client</span>

    <span class="k">begin</span>
      <span class="n">content</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">contents</span> <span class="n">repo</span><span class="o">[</span><span class="s1">&#39;full_name&#39;</span><span class="o">]</span><span class="p">,</span> <span class="ss">path</span><span class="p">:</span> <span class="s1">&#39;Gemfile.lock&#39;</span>

      <span class="no">File</span><span class="o">.</span><span class="n">open</span> <span class="n">outfile</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span> <span class="k">do</span> <span class="o">|</span><span class="n">out</span><span class="o">|</span>
        <span class="n">out</span><span class="o">.</span><span class="n">puts</span> <span class="no">Base64</span><span class="o">.</span><span class="n">decode64</span> <span class="n">content</span><span class="o">.</span><span class="n">content</span>
      <span class="k">end</span>
    <span class="k">rescue</span> <span class="no">Octokit</span><span class="o">::</span><span class="no">NotFound</span>
      <span class="nb">puts</span> <span class="s2">&#34;No Gemfile.lock found for </span><span class="si">#{</span><span class="n">repo</span><span class="o">[</span><span class="s1">&#39;full_name&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&#34;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="o">[</span><span class="n">outfile</span><span class="o">].</span><span class="n">invoke</span>
<span class="k">end</span></code></pre></div>
<p>And run it, <code>rake load_gemfiles</code>.  Depending upon how many repos you have, this could take a few seconds.  (Also make sure you&rsquo;ve updated the organization!)</p>

<ol>
<li>Define a file task for each output file, that we will <code>invoke</code> at the very end.</li>
<li>Inside the task, make sure that the <code>environment</code> is loaded.</li>
<li>Pull down the contents of the Gemfile.lock from the API.</li>
</ol>

<p>If you run this a second time, notice that it only attempts to load from the files that weren&rsquo;t loaded before.</p>

<p>For fun, delete the <code>data</code> directly and run the rake task again.  BOOM!</p>

<h2 id="massaging-the-data-into-something-usable">Massaging the data into something usable</h2>

<ol>
<li><del>Get access to the API.</del></li>
<li><del>Open up a console and start playing with commands.</del></li>
<li><del>Start storing the data locally once we need to get more.</del></li>
<li>Play around with the data.</li>
<li>Design a UI around in.</li>
<li>Refactor the test &ldquo;scripts&rdquo; into ruby classes that fit that UI.</li>
</ol>

<p>OK, now that we have all the data, lets figure out how to slice and dice it.  Lets just wire together some standard UNIX tools to filter and get some info.</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">for_each_elem</span> <span class="s2">&#34;filter_gemfiles&#34;</span><span class="p">,</span> <span class="s2">&#34;data/projects.json&#34;</span> <span class="k">do</span> <span class="o">|</span><span class="n">repo</span><span class="o">|</span>
  <span class="n">sourcefile</span> <span class="o">=</span> <span class="s2">&#34;data/gemfiles/</span><span class="si">#{</span><span class="n">repo</span><span class="o">[</span><span class="s1">&#39;name&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">.Gemfile.lock&#34;</span>
  <span class="n">outfile</span> <span class="o">=</span> <span class="s2">&#34;data/filtered/</span><span class="si">#{</span><span class="n">repo</span><span class="o">[</span><span class="s1">&#39;name&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">.gems&#34;</span>
  <span class="no">FileUtils</span><span class="o">.</span><span class="n">mkdir_p</span> <span class="s2">&#34;data/filtered&#34;</span>

  <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span> <span class="n">sourcefile</span> <span class="p">)</span>
    <span class="n">file</span> <span class="n">outfile</span> <span class="k">do</span>
      <span class="nb">system</span><span class="p">(</span> <span class="s2">&#34;awk &#39;/^    [^ ]/ { print $1, $2 }&#39; </span><span class="si">#{</span><span class="n">sourcefile</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">#{</span><span class="n">outfile</span><span class="si">}</span><span class="s2">&#34;</span> <span class="p">)</span>
    <span class="k">end</span>
    <span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="o">[</span><span class="n">outfile</span><span class="o">].</span><span class="n">invoke</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>
<p>Running <code>rake filter_gemfiles</code> will go through and only show the specific gems that were locked out the Gemfile.locks.  Obviously, filtering the file based on the fact that it has exactly 4 spaces isn&rsquo;t robust, but it works.</p>

<p>Lets add a couple of other nifty methods:</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="n">file</span> <span class="s2">&#34;data/versioned.list&#34;</span> <span class="k">do</span>
  <span class="nb">system</span><span class="p">(</span> <span class="s2">&#34;cat data/filtered/* | sort | uniq -c | sort -rn &gt; data/versioned.list&#34;</span> <span class="p">)</span>
<span class="k">end</span>

<span class="n">file</span> <span class="s2">&#34;data/gems.list&#34;</span> <span class="k">do</span>
  <span class="nb">system</span><span class="p">(</span> <span class="s2">&#34;awk &#39;{print $1}&#39; data/filtered/* | sort | uniq -c | sort -rn &gt; data/gems.list&#34;</span><span class="p">)</span>
<span class="k">end</span></code></pre></div>
<p>I&rsquo;m going to stop here, but in case you are wondering the top gems that we use are:</p>

<ol>
<li>(82) json</li>
<li>(81) tzinfo</li>
<li>(81) i18n</li>
<li>(81) activesupport</li>
<li>(79) rack</li>
<li>(79) multi_json</li>
<li>(78) sass</li>
<li>(77) rack-test</li>
<li>(76) tilt</li>
<li>(76) mime-types</li>
</ol>

<h2 id="repeatable-data-in-10-minutes">Repeatable data in 10 minutes</h2>

<p>There&rsquo;s lots of stuff you can do from there, the most likely one being &ldquo;sending an email and forgetting about it.&rdquo;  But lets look at what we have.</p>

<ol>
<li>The access key isn&rsquo;t hard coded anywhere.  When you come back to this, if it expires, you just reconnect on the website.</li>
<li>Way easier to get access keys this way, only a few oauth providers make this simple.  (Twitter does, for example, github doesn&rsquo;t.)</li>
<li>There&rsquo;s a direct process transitioning from &lsquo;playing around&rsquo; to automated.</li>
<li>Loading the data from the remote API is automated and repeatable.  If you&rsquo;ve setup the dependancies correctly, you can run the rake tasks and things magically get up to date.</li>
<li>If you do want to build a UI around this, you already have a webapp up and running&hellip;</li>
</ol>

<p>Importantly, this is something that you can get up and going with in under 10 minutes, at least if you know how the API works.  It takes less that 1 minute to get to the point where you have an authenticated client to the remote service and you can spend time exploring.</p>

<p>One of the reasons I like having seed around to help prototype and explore ideas!</p>

<p>Source code can be found: <a href="https://github.com/wschenk/project_stats_demo">https://github.com/wschenk/project_stats_demo</a></p>

  </article>
</div>


  <div class="bg-light py-5">
    <div class="container">
      <h2 class="text-center">Read next</h2>

      <div class="row">
        <div class="col-md-6 text-center">
          
            Next Post:
            <a href="../../../articles/2016/owning-a-tesla-in-brooklyn/">Owning a Tesla inÂ Brooklyn</a>
          
        </div>
        <div class="col-md-6 text-center">
          
            Previous Post:
            <a href="../../../articles/2015/building-a-gui-for-managing-middleman-blogs/">Building a GUI for managing middleman blogs</a>
          
        </div>
      </div>
    </div>
  </div>




<div class="container mt-5">
  <h2 class="text-center">See also</h2>
  <div class="row">
  	
      <div class="col-md mb-3">
        <p class="lead mb-0"><a class="text-body" href="../../../articles/2015/setting-up-devise-with-twitter-and-facebook-and-other-omniauth-schemes-without-email-addresses/">Setting up Devise with Twitter and Facebook and other Omniauth schemes without email addresses</a></p>

        
          <p class="lead font-italic mb-0">Connect connect connect</p>
        
        <p class="font-weight-light mt-3">Adding social login to your sites really makes it easier to get users onboard. Devise is great to help get an authentication system up and running, but there are a few tricky things to get right. The first challenge is that you don&rsquo;t always get the user&rsquo;s email address when the first connect. The second challenge is that we want to request the minimum permissions first so that the user is more likely to sign up, and gradually ask more as the time arises.</p>
        <a href="../../../articles/2015/setting-up-devise-with-twitter-and-facebook-and-other-omniauth-schemes-without-email-addresses/" class="btn btn-primary">Read more</a>
      </div>
    
      <div class="col-md mb-3">
        <p class="lead mb-0"><a class="text-body" href="../../../articles/2015/setting-up-testing/">Setting up Rails testing with rspec, devise, and the gang</a></p>

        
          <p class="lead font-italic mb-0">so much fun</p>
        
        <p class="font-weight-light mt-3">The goal is to get features out fast, and iterate on them quickly. Does anyone care about it? What do they care about? How do we make it better?
As projects get bigger, both in terms of people using the site as well as people working on the site, testing and quality become relatively more important. Adding tests introduces drag, and the theory is that you invest now for payoffs later.</p>
        <a href="../../../articles/2015/setting-up-testing/" class="btn btn-primary">Read more</a>
      </div>
    
      <div class="col-md mb-3">
        <p class="lead mb-0"><a class="text-body" href="../../../articles/2014/using-rake-for-dataflow-programming-and-data-science/">Using rake for dataflow programming and data science</a></p>

        
          <p class="lead font-italic mb-0">Rake it like&rsquo;s hot</p>
        
        <p class="font-weight-light mt-3">I&rsquo;ve been using Rake more and more for data collection and processing tasks. Rake is pretty pretty powerful. Most people know it as way to add external tasks to a Rails app, but it&rsquo;s actually very powerful build system. We&rsquo;re going to take advantage of that to build out a framework that will make it easy to collect, process, and interpret data while keeping it all in sync.
In fact, if you just want to start playing with stuff now, head over to the rake-data site to go through some walk throughs.</p>
        <a href="../../../articles/2014/using-rake-for-dataflow-programming-and-data-science/" class="btn btn-primary">Read more</a>
      </div>
    
  </div>
</div>


<footer class="footer bg-dark text-light mt-3">
  <div class="container">
    <h2 class="py-5 font-weight-light my-0">Made in Brooklyn, NY.</h2>
  </div>
</footer>
</body>
</html>
