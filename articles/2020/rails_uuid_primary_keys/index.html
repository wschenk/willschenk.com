<!doctype html><html><head><title>rails uuid primary key</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet href=../../../css/theme.css><link rel=stylesheet href=../../../css/syntax.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-56296045-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script async defer data-domain=willschenk.com src=https://plausible.io/js/plausible.js></script><meta property="og:title" content="rails uuid primary key"><meta property="og:description" content="Exposing primary keys externally just sort of invites people to poke around in your system. Lets configure rails to use uuid instead. Create a postgres rails app   We are going to be relying upon the pgcrypto postgres extension, so lets go ahead a create a postgres based rails application. rails new testapp -d=postgresql cd testapp   Now we tell our generators that we want our primary key type to be :uuid: # config/initializers/generators."><meta property="og:type" content="article"><meta property="og:url" content="https://willschenk.com/articles/2020/rails_uuid_primary_keys/"><meta property="article:published_time" content="2020-11-22T00:00:00+00:00"><meta property="article:modified_time" content="2020-11-22T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="rails uuid primary key"><meta name=twitter:description content="Exposing primary keys externally just sort of invites people to poke around in your system. Lets configure rails to use uuid instead. Create a postgres rails app   We are going to be relying upon the pgcrypto postgres extension, so lets go ahead a create a postgres based rails application. rails new testapp -d=postgresql cd testapp   Now we tell our generators that we want our primary key type to be :uuid: # config/initializers/generators."><meta name=twitter:site content="@wschenk"><style>.article p,.article ul,.article ol,.article table{max-width:45em}.article pre p{max-width:none;margin-top:-1.5rem}article.article p:first-child,.article blockquote{font-size:1.25em;font-weight:300;max-width:36em}.half-height-scroll{max-height:32em;overflow:scroll}</style></head><body><nav class="container my-5"><h1 class="pt-md-5 display-3"><a class=text-dark href=../../../>Will Schenk</a></h1><p><a class="text-dark h4 mr-3 font-weight-light" href=../../../articles/>Articles</a>
<a class="text-dark h4 mr-3 font-weight-light" href=../../../contact>Contact</a>
<a class="text-dark h4 mr-3 font-weight-light" href=../../../tags/>Tags</a>
<a href=../../../feed.xml class="mr-3 h4 text-light"><img src=../../../img/rss.svg alt=rss height=20 width=20></a>
<a href=https://twitter.com/@wschenk class="mr-3 h4 text-light"><img src=../../../img/twitter.svg alt=twitter height=20 width=20></a>
<a href=https://instagram.com/wschenk class="mr-3 h4 text-light"><img src=../../../img/instagram.svg alt=instagram height=20 width=20></a>
<a href=https://github.com/wschenk class="mr-3 h4 text-light"><img src=../../../img/github.svg alt=github height=20 width=20></a>
<a href=https://linkedin.com/in/will-schenk-420266 class="mr-3 h4 text-light"><img src=../../../img/linkedin.svg alt=linkedin height=20 width=20></a></p></nav><div class=container><h1 class=mt-5>rails uuid primary key</h1><h2 class="font-weight-light font-italic mb-3">Slightly more obscure</h2><p class="text-muted mt-3"><a class=text-muted href=https://willschenk.com/articles/2020/rails_uuid_primary_keys/>Published November 22, 2020</a>
<a class=text-muted href=../../../tags/rails>#rails,</a>
<a class=text-muted href=../../../tags/uuid>#uuid,</a>
<a class=text-muted href=../../../tags/postgres>#postgres</a></p><article class="article mt-5"><p>Exposing primary keys externally just sort of invites people to poke around in your system. Lets configure rails to use <code class=verbatim>uuid</code> instead.</p><h2 id=headline-1>Create a postgres rails app</h2><p>We are going to be relying upon the <code class=verbatim>pgcrypto</code> postgres extension, so
lets go ahead a create a postgres based rails application.</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>rails new testapp -d<span class=o>=</span>postgresql
<span class=nb>cd</span> testapp</code></pre></div></div><p>Now we tell our generators that we want our primary key type to be <code class=verbatim>:uuid</code>:</p><div class="src src-ruby"><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=c1># config/initializers/generators.rb</span>
<span class=no>Rails</span><span class=o>.</span><span class=n>application</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>generators</span> <span class=k>do</span> <span class=o>|</span><span class=n>g</span><span class=o>|</span>
  <span class=n>g</span><span class=o>.</span><span class=n>orm</span> <span class=ss>:active_record</span><span class=p>,</span> <span class=ss>primary_key_type</span><span class=p>:</span> <span class=ss>:uuid</span>
<span class=k>end</span></code></pre></div></div><p>And we need to change the sort order, since when using integer id's
for the primary key rails uses that. We'll tell it to use <code class=verbatim>created_at</code>
instead:</p><div class="src src-ruby"><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=c1># app/models/application_record.rb</span>
<span class=k>class</span> <span class=nc>ApplicationRecord</span> <span class=o>&lt;</span> <span class=no>ActiveRecord</span><span class=o>::</span><span class=no>Base</span>
  <span class=nb>self</span><span class=o>.</span><span class=n>abstract_class</span> <span class=o>=</span> <span class=kp>true</span>
  <span class=c1># Sort records by date of creation instead of primary key</span>
  <span class=nb>self</span><span class=o>.</span><span class=n>implicit_order_column</span> <span class=o>=</span> <span class=ss>:created_at</span>
<span class=k>end</span></code></pre></div></div><p>Create your first migration</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>rails g model post title content:text</code></pre></div></div><p>And make sure that we add to the <code class=verbatim>change</code> method of the migration!</p><div class="src src-ruby"><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=n>enable_extension</span> <span class=s1>&#39;pgcrypto&#39;</span> <span class=k>unless</span> <span class=n>extension_enabled?</span><span class=p>(</span><span class=s1>&#39;pgcrypto&#39;</span><span class=p>)</span></code></pre></div></div><h2 id=headline-2>Start postgres and test it out</h2><p>Lets create a throwaway postgres container to see how things are working</p><div class="src src-bash"><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker run -it --rm -p 5432:5432 -e <span class=nv>POSTGRES_PASSWORD</span><span class=o>=</span>password postgres:13.1</code></pre></div></div><p>This will delete itself when you close out of it.</p><p>We'll need to create a simple <code class=verbatim>config/database.yml</code> file to connect to it:</p><div class="src src-ruby"><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=ss>default</span><span class=p>:</span> <span class=o>&amp;</span><span class=n>default</span>
  <span class=ss>adapter</span><span class=p>:</span> <span class=n>postgresql</span>
  <span class=ss>encoding</span><span class=p>:</span> <span class=n>unicode</span>
  <span class=ss>host</span><span class=p>:</span> <span class=n>localhost</span>
  <span class=ss>username</span><span class=p>:</span> <span class=n>postgres</span>
  <span class=ss>password</span><span class=p>:</span> <span class=n>password</span>
  <span class=ss>pool</span><span class=p>:</span> <span class=o>&lt;%=</span> <span class=no>ENV</span><span class=o>.</span><span class=n>fetch</span><span class=p>(</span><span class=s2>&#34;RAILS_MAX_THREADS&#34;</span><span class=p>)</span> <span class=p>{</span> <span class=mi>5</span> <span class=p>}</span> <span class=o>%&gt;</span>

<span class=ss>development</span><span class=p>:</span>
  <span class=o>&lt;&lt;</span><span class=p>:</span> <span class=o>*</span><span class=n>default</span>
  <span class=ss>database</span><span class=p>:</span> <span class=n>testapp_development</span>

<span class=nb>test</span><span class=p>:</span>
  <span class=o>&lt;&lt;</span><span class=p>:</span> <span class=o>*</span><span class=n>default</span>
  <span class=ss>database</span><span class=p>:</span> <span class=n>testapp_test</span>

<span class=ss>production</span><span class=p>:</span>
  <span class=o>&lt;&lt;</span><span class=p>:</span> <span class=o>*</span><span class=n>default</span>
  <span class=ss>database</span><span class=p>:</span> <span class=n>testapp_production</span></code></pre></div></div><p>And then we create and migrate:</p><div class="src src-text"><div class=highlight><pre class=chroma><code class=language-text data-lang=text>rake db:create:all
rake db:migrate</code></pre></div></div><p>And now we can test it out:</p><div class="src src-ruby"><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=err>$</span> <span class=n>rails</span> <span class=n>c</span>
<span class=no>Running</span> <span class=n>via</span> <span class=no>Spring</span> <span class=n>preloader</span> <span class=k>in</span> <span class=n>process</span> <span class=mi>3134</span>
<span class=no>Loading</span> <span class=n>development</span> <span class=n>environment</span> <span class=p>(</span><span class=no>Rails</span> <span class=mi>6</span><span class=o>.</span><span class=mi>0</span><span class=o>.</span><span class=mi>3</span><span class=o>.</span><span class=mi>4</span><span class=p>)</span>
<span class=n>irb</span><span class=p>(</span><span class=n>main</span><span class=p>):</span><span class=mo>001</span><span class=p>:</span><span class=mi>0</span><span class=o>&gt;</span> <span class=no>Post</span><span class=o>.</span><span class=n>create</span> <span class=ss>title</span><span class=p>:</span> <span class=s2>&#34;First post&#34;</span>
   <span class=p>(</span><span class=mi>0</span><span class=o>.</span><span class=mi>5</span><span class=n>ms</span><span class=p>)</span>  <span class=k>BEGIN</span>
  <span class=no>Post</span> <span class=no>Create</span> <span class=p>(</span><span class=mi>3</span><span class=o>.</span><span class=mi>5</span><span class=n>ms</span><span class=p>)</span>  <span class=no>INSERT</span> <span class=no>INTO</span> <span class=s2>&#34;posts&#34;</span> <span class=p>(</span><span class=s2>&#34;title&#34;</span><span class=p>,</span> <span class=s2>&#34;created_at&#34;</span><span class=p>,</span> <span class=s2>&#34;updated_at&#34;</span><span class=p>)</span> <span class=no>VALUES</span> <span class=p>(</span><span class=vg>$1</span><span class=p>,</span> <span class=vg>$2</span><span class=p>,</span> <span class=vg>$3</span><span class=p>)</span> <span class=no>RETURNING</span> <span class=s2>&#34;id&#34;</span>  <span class=o>[[</span><span class=s2>&#34;title&#34;</span><span class=p>,</span> <span class=s2>&#34;First post&#34;</span><span class=o>]</span><span class=p>,</span> <span class=o>[</span><span class=s2>&#34;created_at&#34;</span><span class=p>,</span> <span class=s2>&#34;2020-11-22 16:36:20.826249&#34;</span><span class=o>]</span><span class=p>,</span> <span class=o>[</span><span class=s2>&#34;updated_at&#34;</span><span class=p>,</span> <span class=s2>&#34;2020-11-22 16:36:20.826249&#34;</span><span class=o>]]</span>
   <span class=p>(</span><span class=mi>8</span><span class=o>.</span><span class=mi>7</span><span class=n>ms</span><span class=p>)</span>  <span class=no>COMMIT</span>
<span class=o>=&gt;</span> <span class=c1>#&lt;Post id: &#34;4c3f20d0-a17b-473d-99f1-9824ba5207c2&#34;, title: &#34;First post&#34;, content: nil, created_at: &#34;2020-11-22 16:36:20&#34;, updated_at: &#34;2020-11-22 16:36:20&#34;&gt;</span>
<span class=n>irb</span><span class=p>(</span><span class=n>main</span><span class=p>):</span><span class=mo>002</span><span class=p>:</span><span class=mi>0</span><span class=o>&gt;</span> <span class=no>Post</span><span class=o>.</span><span class=n>create</span> <span class=ss>title</span><span class=p>:</span> <span class=s2>&#34;Second post&#34;</span>
   <span class=p>(</span><span class=mi>3</span><span class=o>.</span><span class=mi>1</span><span class=n>ms</span><span class=p>)</span>  <span class=k>BEGIN</span>
  <span class=no>Post</span> <span class=no>Create</span> <span class=p>(</span><span class=mi>13</span><span class=o>.</span><span class=mi>0</span><span class=n>ms</span><span class=p>)</span>  <span class=no>INSERT</span> <span class=no>INTO</span> <span class=s2>&#34;posts&#34;</span> <span class=p>(</span><span class=s2>&#34;title&#34;</span><span class=p>,</span> <span class=s2>&#34;created_at&#34;</span><span class=p>,</span> <span class=s2>&#34;updated_at&#34;</span><span class=p>)</span> <span class=no>VALUES</span> <span class=p>(</span><span class=vg>$1</span><span class=p>,</span> <span class=vg>$2</span><span class=p>,</span> <span class=vg>$3</span><span class=p>)</span> <span class=no>RETURNING</span> <span class=s2>&#34;id&#34;</span>  <span class=o>[[</span><span class=s2>&#34;title&#34;</span><span class=p>,</span> <span class=s2>&#34;Second post&#34;</span><span class=o>]</span><span class=p>,</span> <span class=o>[</span><span class=s2>&#34;created_at&#34;</span><span class=p>,</span> <span class=s2>&#34;2020-11-22 16:36:27.499092&#34;</span><span class=o>]</span><span class=p>,</span> <span class=o>[</span><span class=s2>&#34;updated_at&#34;</span><span class=p>,</span> <span class=s2>&#34;2020-11-22 16:36:27.499092&#34;</span><span class=o>]]</span>
   <span class=p>(</span><span class=mi>26</span><span class=o>.</span><span class=mi>5</span><span class=n>ms</span><span class=p>)</span>  <span class=no>COMMIT</span>
<span class=o>=&gt;</span> <span class=c1>#&lt;Post id: &#34;2c1da815-dfe4-48e5-bdb7-13a573035825&#34;, title: &#34;Second post&#34;, content: nil, created_at: &#34;2020-11-22 16:36:27&#34;, updated_at: &#34;2020-11-22 16:36:27&#34;&gt;</span>
<span class=n>irb</span><span class=p>(</span><span class=n>main</span><span class=p>):</span><span class=mo>003</span><span class=p>:</span><span class=mi>0</span><span class=o>&gt;</span> <span class=no>Post</span><span class=o>.</span><span class=n>last</span>
  <span class=no>Post</span> <span class=no>Load</span> <span class=p>(</span><span class=mi>0</span><span class=o>.</span><span class=mi>7</span><span class=n>ms</span><span class=p>)</span>  <span class=no>SELECT</span> <span class=s2>&#34;posts&#34;</span><span class=o>.</span><span class=n>*</span> <span class=no>FROM</span> <span class=s2>&#34;posts&#34;</span> <span class=no>ORDER</span> <span class=no>BY</span> <span class=s2>&#34;posts&#34;</span><span class=o>.</span><span class=s2>&#34;created_at&#34;</span> <span class=no>DESC</span> <span class=no>LIMIT</span> <span class=vg>$1</span>  <span class=o>[[</span><span class=s2>&#34;LIMIT&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=o>]]</span>
<span class=o>=&gt;</span> <span class=c1>#&lt;Post id: &#34;2c1da815-dfe4-48e5-bdb7-13a573035825&#34;, title: &#34;Second post&#34;, content: nil, created_at: &#34;2020-11-22 16:36:27&#34;, updated_at: &#34;2020-11-22 16:36:27&#34;&gt;</span></code></pre></div></div><p>The sql for the <code class=verbatim>Post.last</code> command is <code class=verbatim>SELECT "posts".* FROM "posts"
ORDER BY "posts"."created_at" DESC LIMIT $1</code> which is using the
<code class=verbatim>created_at</code> column.</p><h2 id=headline-3>But this doesn't support sqlite</h2><p>The <code class=verbatim>uuid</code> column type isn't supported by sqlite. I think it's better
to test on the same database type as production, and with docker it's
easy to throw things up and tear them down, etc. but caveat.</p><h2 id=headline-4>References</h2><ol><li><p><a href=https://pawelurbanek.com/uuid-order-rails>UUID Primary Key in Rails 6 with PostgreSQL and Active Record</a></p></li><li><p><a href=https://itnext.io/using-uuids-to-your-rails-6-application-6438f4eeafdf>Using UUIDs to your new Rails 6 application</a></p></li></ol></article></div><div class="bg-light py-5"><div class=container><h2 class=text-center>Read next</h2><div class=row><div class="col-md-6 text-center"></div><div class="col-md-6 text-center">Previous Post:
<a href=../../../articles/2020/tailwind_and_rails/>Tailwind and Rails</a></div></div></div></div><div class="container mt-5"><h2 class=text-center>See also</h2><div class=row><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2020/tailwind_and_rails/>Tailwind and Rails</a></p><p class="lead font-italic mb-0">postcss setup</p><div class="font-weight-light mt-3"><p>Tailwind is a really nice set of CSS utility classes that let you style up a page staying largely in one file at a time. Rails has it's own wild way of dealing with javascript, so lets go through how to make them play well together. Install tailwindcss Make sure that you have node 12.13 or higher: node -v If not, then upgrade node. Inside of your rails project, install tailwind.</p></div><a href=../../../articles/2020/tailwind_and_rails/ class="btn btn-primary">Read more</a></div><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=../../../articles/2020/rails_in_docker/>Rails in Docker</a></p><p class="lead font-italic mb-0">Why install ruby locally?</p><div class="font-weight-light mt-3"><p>In leveraging disposability for exploration we looked at how to build software without having it installed on your local computer. Lets go through how to setup and develop a rails application with this process. docker-compose.yml all the way down We're going to create our app by adding things to a docker-compose.yml file as needed. Lets create the first one, which will contain our rails container as well as a volume for keeping track of all the gems.</p></div><a href=../../../articles/2020/rails_in_docker/ class="btn btn-primary">Read more</a></div></div></div><footer class="footer bg-dark text-light mt-3"><div class=container><h2 class="py-5 font-weight-light my-0">Made in Brooklyn, NY.</h2></div></footer></body></html>