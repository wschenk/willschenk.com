#!/usr/bin/env ruby

require 'bundler/inline'

gemfile do
  source 'https://rubygems.org'
  gem 'front_matter_parser'
end

require 'fileutils'
require 'date'

BASE_DIR="/Users/wschenk/willschenk.com"
WORK_DIR="/tmp"
TEMPLATE = DATA.read


class Page
  attr_reader :title, :subtitle, :section, :tags
  def initialize( file )
    @file = file
    read_attributes_org if File.extname(@file) == ".org"
    read_attributes_md if File.extname(@file) == ".md"
    @section = @file.split( /\// )[-4]
  end

  def outdir
    File.dirname(@file.gsub( /#{BASE_DIR}/, WORK_DIR ))
  end

  def outfile
    "#{outdir}/cover.png"
  end

  def read_attributes_md
    loader = FrontMatterParser::Loader::Yaml.new(allowlist_classes: [Date,Time])
    parsed = FrontMatterParser::Parser.parse_file(@file, loader: loader)
          
    fm = parsed.front_matter
    @title = fm['title']
    @subtitle = fm['subtitle'] || ""
    @tags = fm['tags']
  end

  def read_attributes_org
    contents = File.read( @file ).split( /\n/ );
    @title = contents.grep( /#\+title/ ).first.split( /:/ ).last
    subtitle = contents.grep( /#\+subtitle/ ).first
    if subtitle
      @subtitle = subtitle.split(/:/).last
    else
      @subtitle = ""
    end
    @tags = contents.grep( /#\+tags/ )
  end

  def make_image
    FileUtils.mkdir_p outdir
    file = "#{outdir}/og.html"
    puts "writing #{file}"
    File.open( file, "w" ) do |out|
      template = TEMPLATE.gsub( /SUBTITLE/, @subtitle )
      template = template.gsub( /TITLE/, @title )
      template = template.gsub( /SECTION/, @section )
      template = template.gsub( /BEARD_IMAGE/, "file://#{BASE_DIR}/beard.png" )
      out << template
    end

    cmd = "shot-scraper -w 1200 -h 630 -o #{outfile} #{file}"

    puts "Running #{cmd}"
    system(cmd)

    cmd = "cp #{outfile} #{File.dirname( @file )}"
    puts "Running #{cmd}"
    system(cmd)
  end

  def exist?
    File.exist? "#{File.dirname( @file )}/cover.png"
  end
end

Dir.glob( "#{BASE_DIR}/content/*/*/*/index.{org,md}" ).each do |file|
  p = Page.new( file )
  if !p.exist?
    p.make_image
  end
end

__END__
<!DOCTYPE html>
  <html lang="en">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>OG Image</title>
      <style>
@import url('https://fonts.googleapis.com/css2?family=Maiden+Orange&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600&display=swap');

:root {
    --color-paper: #F5F0E8;
    --color-ink: #1A1A1A;
    --color-ink-faded: #6B6B6B;
    --font-display: "Maiden Orange", Georgia, serif;
    --font-body: "Crimson Pro", Georgia, serif;
}

body {
  font-family: var(--font-body);
  color: var(--color-ink);
  background: var(--color-paper);
  margin: 0;
}

main {
  max-width: 1200px;
  height: 630px;
  display: flex;
  align-items: center;
  padding-left: 80px;
  padding-right: 80px;
  position: relative;
  overflow: hidden;
}

.beard-icon {
  position: absolute;
  right: 60px;
  bottom: -20px;
  height: 520px;
  opacity: 0.12;
}

h1 {
  font-family: var(--font-display);
  font-size: 76px;
  color: var(--color-ink);
  margin: 0 0 12px;
  line-height: 1.1;
}

h2 {
  font-family: var(--font-body);
  font-size: 42px;
  font-weight: 400;
  color: var(--color-ink-faded);
  margin: 0;
  line-height: 1.3;
}

h3 {
  font-family: var(--font-body);
  font-size: 28px;
  font-weight: 600;
  color: var(--color-ink-faded);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin: 0 0 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--color-ink);
  display: inline-block;
}

      </style>
    </head>
    <body>
      <main>
        <div>
          <h3>SECTION</h3>
          <h1>TITLE</h1>
          <h2>SUBTITLE</h2>
        </div>
        <img class="beard-icon" src="BEARD_IMAGE" alt="">
      </main>
    </body>
  </html>
