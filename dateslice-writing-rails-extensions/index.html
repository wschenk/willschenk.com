<!DOCTYPE html>
<html class='no-js'>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
    <title>Dateslice: Writing rails extensions | Will Schenk</title>
    <meta name="site" content="Will Schenk" />
    <meta name="og:site_name" content="Will Schenk" />
    <meta name="title" content="Dateslice: Writing rails extensions" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Dateslice: Writing rails extensions" />
    <meta name="twitter:creator" content="@wschenk" />
    <meta name="og:title" content="Dateslice: Writing rails extensions" />
    <!-- - if current_article -->
    <!-- %title= current_article.title -->
    <!-- - else -->
    <!-- %title Will Schenk -->
    <!-- %meta{ :name => 'description', :content => '' }/ -->
    <meta content='width=device-width' name='viewport'>
    <link href="../stylesheets/application-4b15808a.css" rel="stylesheet" type="text/css" /><link href="../stylesheets/socicons-d8ab83dd.css" rel="stylesheet" type="text/css" /><link href="../stylesheets/animate-8335fea6.css" rel="stylesheet" type="text/css" /><link href="../stylesheets/xcode-11a7835a.css" rel="stylesheet" type="text/css" />
    <link href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/styles/default.min.css' rel='stylesheet'>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
  </head>
  <body>
    <div class='banner'>
      <img class="fadeInDown animated" src="../images/train-f63e7ab9.jpg" />
    </div>
    <div class='article-header lighter dark_header'>
      <h1>Dateslice: Writing rails extensions</h1>
      <h2>adding date group_by to ActiveRecord</h2>
      <div class='avatar'>
        <a href='/'>
          <img class="img-responsive" src="../images/avatar-87e8d0c3.jpg" />
        </a>
      </div>
      <h3><a href="/">Will Schenk</a></h3>
      <span class='disqus-comment-count' data-disqus-identifier='2014-12-07-dateslice-writing-rails-extensions.html'></span>
      <!-- %p.social -->
      <!-- - (config.social || {}).each do |type,url| -->
      <!-- %a{ href: url } -->
      <!-- %span{ class: "socicon socicon-#{type.to_s} fgcolor" } -->
    </div>
    <div class='container-fluid content'>
      <div class='row'>
        <div class='article'>
          <p>Ruby on Rails is a very modular framework since the merging with Merb in 2008.  The <em>opinionated conventions</em> are implemented under using techniques that let you jump in and build your own components, picking and choosing different parts that let you build Rails apps in the same straightforward way you would if using the official modules.</p>
          
          <p>Let&#39;s go through the <a href="https://github.com/HappyFunCorp/dateslices"><code>dateslices</code> gem</a> which I wrote to extend active record so that we could better interact with the <code>group by</code> sql command when dealing with dates.  Thanks to <a href="https://github.com/mbrookes">mbrookes</a> this command now outputs in a format compatible with <a href="http://ankane.github.io/chartkick/">Chartkick</a> making it a good tool to use when graphing date related things, say user signups, on an admin panel for your application.</p>
          
          <h2>Databases</h2>
          
          <p><a href="http://guides.rubyonrails.org/active_record_basics.html">ActiveRecord</a> is how Rails interacts with the database, this includes both SQL generation, validations, and a whole bunch more.  It creates a startardized interface over the many subtle differences between SQL implementations on different databases.  Date handling and grouping on dymanic terms is one area where databases differer greatly from one another, and when we want to find counts and sums grouped by different dates we need to tune our SQL for the vagaries of switching to different databases.</p>
          
          <h2>Keeping development the same as production</h2>
          
          <p>I tend to develop locally on Sqlite3 and deploy on Postgres.  When we get into something fancy where we want to use some of the amazing features that Postgres has, like <a href="http://www.postgresql.org/docs/9.2/static/libpq-notify.html">LISTEN/NOTIFY</a> or <a href="http://postgresguide.com/sexy/hstore.html">hstore</a> , then it makes sense to run a Postgres instance locally.  But most of the time it&#39;s overkill, and I prefer running with Sqlite3 since I just need to checkout the project, run bundle, and I&#39;m in a self contained environment.</p>
          
          <p>Pub/sub and attribute store are cool enough things to warrant managing a local Postgres instance, grouping by date doesn&#39;t cut it in my book.</p>
          
          <p>If you do already have a Postgres instance running locally, then you should check out the <a href="https://github.com/ankane/groupdate"><code>groupdate</code> gem</a>, which is better and worse than <code>dateslice</code>: better because it supports Timezones which is awesome and difficult to solve well and worse because it doesn&#39;t support Sqlite3.</p>
          
          <h2>Enter dataslice</h2>
          
          <p>Lets first take a look at how the SQL differs between the different databases.  The basic structure is</p>
          
          <pre><code class="sql">select aggregation(aggregation_column), timeslice from table group by timeslice&#x000A;</code></pre>
          
          <p>Where <code>aggregation</code> is one of <code>count</code>, <code>sum</code>, and <code>avg</code>.</p>
          
          <p><code>aggregation_column</code> is the column we are counting, summing or averaging.  For counts, normally we do <code>count(*)</code> but we can also do <code>count(distinct(aggregation_column))</code> if you only want to count the number of unique occurances.</p>
          
          <p><code>timeslice</code> is the time period that we want to look at.  The basic idea here is that we convert a <code>datetime</code> to a string with lower precision (getting rid of the seconds, or minutes, or hours, or days) and then group on that string.  We need to select this on the left side of the query, and we also need it as the input of the <code>GROUP BY</code> on the right.</p>
          
          <p>For example, if we want to group by day, this is the SQL that we&#39;d need for the 3 different database variants we are targetting:</p>
          
          <table class="table table-bordered">
            <tr><th>Database</th><th>Time Slice</th></tr>
            <tr><th>Mysql</th><td><code>DATE_FORMAT(#{column}, '%Y-%m-%d 00:00:00 UTC')</code></td></tr>
            <tr><th>Sqlite3</th><td><code>strftime( \"%Y-%m-%d 00:00:00 UTC\", #{column} )</code></td></tr>
            <tr><th>Postgres</th><td><code>DATE_TRUNC( 'day' , #{column} )</code></td></tr>
          </table>
          
          <p>The different variants can be found in the sourecode for <a href="https://github.com/HappyFunCorp/dateslices/blob/master/lib/dateslices/mysql.rb">mysql</a>, <a href="https://github.com/HappyFunCorp/dateslices/blob/master/lib/dateslices/sqlite.rb">sqlite</a>, and <a href="https://github.com/HappyFunCorp/dateslices/blob/master/lib/dateslices/postgresql.rb">Postgres</a>.  (Notice how Postgres is better here too!)</p>
          
          <h2>Our api</h2>
          
          <p>We want to add <code>group_by_second</code>, <code>group_by_minute</code>, <code>group_by_hour</code>, <code>group_by_day</code>, <code>group_by_week</code>, <code>group_by_day_of_week</code>, <code>group_by_month</code>, <code>group_by_year</code> to ActiveRecord classes that we can use either on the model itself:</p>
          
          <pre><code class="rb">User.group_by_day&#x000A;</code></pre>
          
          <p>Or on a scope:</p>
          
          <pre><code class="rb">Post.unmoderated.group_by_day&#x000A;</code></pre>
          
          <p>And get a resulting hash back like:</p>
          
          <pre><code class="rb">{&#x000A;      &quot;2014-07-12 00:00:00 UTC&quot; =&gt; 1,&#x000A;      &quot;2014-07-18 00:00:00 UTC&quot; =&gt; 2,&#x000A;      &quot;2014-07-19 00:00:00 UTC&quot; =&gt; 1&#x000A;}&#x000A;</code></pre>
          
          <p>Or, in a <code>rspec</code> test, something like this:</p>
          
          <pre><code class="rb">  it &quot;should return items grouped by day&quot; do&#x000A;    expect( User.count ).to eq(0)&#x000A;&#x000A;    @initial_time = Time.parse &quot;2014-07-19 15:26:48 -0400&quot;&#x000A;&#x000A;    User.create created_at: @initial_time&#x000A;    User.create created_at: @initial_time - 1.day&#x000A;    User.create created_at: @initial_time - 1.day&#x000A;    User.create created_at: @initial_time - 1.week&#x000A;&#x000A;    expect( User.count ).to eq( 4 )&#x000A;&#x000A;    res = User.group_by_day( :created_at )&#x000A;&#x000A;    expect(res).to eq({&#x000A;      &quot;2014-07-12 00:00:00 UTC&quot; =&gt; 1,&#x000A;      &quot;2014-07-18 00:00:00 UTC&quot; =&gt; 2,&#x000A;      &quot;2014-07-19 00:00:00 UTC&quot; =&gt; 1})&#x000A;  end&#x000A;</code></pre>
          
          <h2>Building the Rails Extension</h2>
          
          <p>Now that we have an idea of what we want to generate, lets take a look at how we build a rails extension.  This is done with the <code>rails plugin new</code> command.  We saw the <code>bundle gem</code> command before back in the <a href="/making-a-command-line-utility-with-gems-and-thor/">making a command line utility with gems and thor</a> post, and in many ways they are similar.  But the <code>rails plugin new</code> command creates a gem setup for a rails environment for testing and developing your app.</p>
          
          <p><a href="http://seed.happyfuncorp.com/">Happy Seed</a> also has a rails plugin generator which will setup rspec testing for you, instead of the default <code>TestUnit</code>.  This runs the <code>rails plugin new</code> command which sets up the rails gem environment and does a few other things you need to do to get rspec working correctly, and HappySeed will do that stuff for you.</p>
          
          <p>Either way, now you have a new folder with an empty gem that we need to fill out.</p>
          
          <p>We&#39;re going to create a <code>Module</code>,  <code>Datelices::Scope</code>, with our methods and then register our methods with the <code>ActiveRecord::Base</code> class.  This looks like so:</p>
          
          <pre><code class="rb"> ActiveRecord::Base.send(:extend, Dateslices::Scopes)&#x000A;</code></pre>
          
          <p>This will mixin our methods into all of the classes that extend <code>ActiveRecord::Base</code>.</p>
          
          <h2>Metaprogramming with Ruby</h2>
          
          <p>Inside of <code>lib/dateslices.rb</code> lets define all of the fields that we want to define.</p>
          
          <pre><code class="rb">module Dateslices&#x000A;  FIELDS = [:second, :minute, :hour, :day, :week, :day_of_week, :month, :year ]&#x000A;end&#x000A;</code></pre>
          
          <p>Now inside of <code>lib/dateslices/scopes.rb</code> we can sketch out our scopes method generator:</p>
          
          <pre><code class="rb">module Dateslices&#x000A;  module Scopes&#x000A;    Dateslices::FIELDS.each do |field|&#x000A;      define_method :&quot;group_by_#{field}&quot; do |*args|&#x000A;        # create query based on args, and field&#x000A;      end&#x000A;    end&#x000A;  end&#x000A;end&#x000A;</code></pre>
          
          <p>Lets go through this for a second.  When this code is evaluated, we are going to loop over <code>Dateslices::FIELDS</code> and call the <code>define_method</code> function for each type of grouping.  These are defined inside of the main <code>Dateslices</code> module, and we are naming our method <code>:&quot;group_by_#{field}&quot;</code>.  Image that a developer writes <code>User.group_by_day( :updated_at )</code>, what happens then?</p>
          
          <p>When that is invoked the Ruby runtime is actually invoking the closure that we are passing into <code>define_method</code>, which is generated inside of the loop with a different value for <code>field</code> on each one.  In addition to using this inside of the name of the function, this value is available inside of the body.  The <code>*args</code> on the other hand, and in our example it would equal <code>[:updated_at]</code>, comes from the method invocation as we would expect.</p>
          
          <p>We are writing code which generates code, and some of the variables are part of our desire &quot;not to write 15 of the basically the same methods&quot; and some of the variables are there to tweak the functionality of the API.</p>
          
          <h2>The SQL Bit</h2>
          
          <p>The full details can be found in <a href="https://github.com/HappyFunCorp/dateslices/blob/master/lib/dateslices/scopes.rb">the repo</a> but here&#39;s the bit that actually generates the query switching out to the various classes that know how to deal with each of the databases that we saw before.</p>
          
          <pre><code class="rb">args = args.dup&#x000A;&#x000A;column = args[0].blank? ? &#39;created_at&#39; : args[0]&#x000A;aggregation = args[1].blank? ? &#39;count&#39; : args[1]&#x000A;aggregation_column = args[2].blank? ? &#39;*&#39; : args[2]&#x000A;&#x000A;sql = [&quot;#{aggregation}(#{aggregation_column}) as count&quot;]&#x000A;&#x000A;time_filter = case connection.adapter_name&#x000A;                when &#39;SQLite&#39;&#x000A;                  Dateslices::Sqlite.time_filter(column, field)&#x000A;                when &#39;PostgreSQL&#39;, &#39;PostGIS&#39;&#x000A;                  Dateslices::Postgresql.time_filter(column, field)&#x000A;                when &#39;MySQL&#39;, &#39;Mysql2&#39;&#x000A;                  Dateslices::Mysql.time_filter(column, field)&#x000A;                else&#x000A;                  throw &quot;Unknown database adaptor #{connection.adapter_name}&quot;&#x000A;              end&#x000A;&#x000A;sql &lt;&lt; &quot;#{time_filter} as date_slice&quot;&#x000A;&#x000A;slices = select( sql.join(&#39;, &#39;)).where.not(column =&gt; nil).group(&#39;date_slice&#39;).order(&#39;date_slice&#39;)&#x000A;</code></pre>
          
          <p>The full code does a bit more to figure out how you want to see the data, but that&#39;s the tricky stuff.</p>
          
          <h2>Testing a rails plugin that talks to many databases</h2>
          
          <p>The first thing that&#39;s a little strange when testing a plugin is that you can test your gem in two different contexts: one in a basic ruby context, and your tests go into <code>spec/</code>, and the other in a rails context.  The plugin generator will create a sample rails app inside of <code>spec/dummy</code> (or <code>test/dummy</code> if you are using <code>rails plugin new</code> without our fancy rspec stuff).  </p>
          
          <p>Let&#39;s take a look now at how to test a gem that talks to many different databases.  Normally when we start up a rails environment, test or otherwise, it connects to a database and that&#39;s that.  However, we need to run the same test suite over 3 different databases making sure that the gem behaves in exactly the same way for each one.</p>
          
          <p>Here&#39;s our <code>spec/dummy/spec/models/test_spec.rb</code></p>
          
          <pre><code class="rb">require &#39;rails_helper&#39;&#x000A;require &#39;dateslice_tester&#39;&#x000A;require &#39;groupdate_tester&#39;&#x000A;&#x000A;databases = [{ :adapter =&gt; &#39;mysql&#39;, :database =&gt; &#39;dateslice_test&#39;, :user =&gt; &#39;root&#39;},&#x000A;             { :adapter =&gt; &#39;postgresql&#39;, :database =&gt; &#39;dateslice_test&#39;},&#x000A;             { :adapter =&gt; &#39;sqlite3&#39;, :database =&gt; &#39;db/test.sqlite3&#39;}]&#x000A;&#x000A;formats = [&#39;groupdate&#39;, &#39;dateslice&#39;]&#x000A;&#x000A;databases.each do |database|&#x000A;  formats.each do |format|&#x000A;    RSpec.describe &quot;#{database[:adapter].titleize} #{format}&quot;, :type =&gt; :model do&#x000A;      include_examples format, database&#x000A;    end&#x000A;  end&#x000A;end&#x000A;</code></pre>
          
          <p><em>This code was based on something I cobbled together but cleaned up by <a href="https://github.com/mbrookes">mbrookes</a>, thanks mbrooks!</em></p>
          
          <p>We first define a set a database configuration for our test databases.  We then loop over that, and use the <code>include_examples</code> feature of <code>RSpec</code>, passing in the both the output format and the database configuration that we want to test.  We have two files of examples, one which defines the <code>groupdate</code> format, and the other which defines the <code>dateslices</code> format.  Once again I&#39;d like to point out that if you don&#39;t care about SQLite3 support and want Timezone support, the <a href="https://github.com/ankane/groupdate">groupdate</a> is what you want.</p>
          
          <p>Lets look at the opening stanzas of <code>spec/dummy/spec/dateslice_tester.rb</code></p>
          
          <pre><code class="rb">RSpec.shared_examples &quot;dateslice&quot; do |config|&#x000A;  before :context do&#x000A;    puts &quot;Setting up #{config}&quot;&#x000A;&#x000A;    ActiveRecord::Base.establish_connection config&#x000A;&#x000A;    puts &quot;Trying to migrate&quot;&#x000A;    ActiveRecord::Migration.create_table :users, :force =&gt; true do |t|&#x000A;      t.string :name&#x000A;      t.integer :score&#x000A;      t.timestamp :created_at&#x000A;      t.timestamp :updated_at&#x000A;    end&#x000A;  end&#x000A;&#x000A;  before do&#x000A;    Dateslices.output_format = :dateslice&#x000A;    User.delete_all&#x000A;  end&#x000A;&#x000A;  it &quot;should return items grouped by day&quot;&#x000A;end&#x000A;</code></pre>
          
          <p><code>RSpec.shared_examples</code> is the counter part to the <code>include</code> examples above, and when it gets called the database <code>config</code> is passed in.  We then call  <code>ActiveRecord::Base.establish_connection config</code> to connect <code>ActiveRecord</code> to the database as part of the <code>before :context</code> part of the RSpec life cycle.</p>
          
          <p>Next we need to actually create the database tables that we are going to run tests over.Â  Since we are switching the databases as part of the testing process itself, it makes no sense to use <code>rake db:create:test</code> to create the DDL, since which database would that be creating?  We need to do 3 different ones, and we certainly don&#39;t want to have an elaborate process to start any of the tests if you decide to add an additional migration.  So we call a migration directly from the code, turning <code>:force =&gt; true</code> so even if it already exists we push the current definition there.</p>
          
          <pre><code class="rb">ActiveRecord::Migration.create_table :users, :force =&gt; true&#x000A;</code></pre>
          
          <p>And then in the regular <code>before</code> callback we make sure that the tables are cleared our ready for the next test.</p>
          
          <h2>That&#39;s just a bit of ActiveRecord</h2>
          
          <p>We&#39;ve just gone through an ActiveRecord extention and that barely scratches the surface of what else you can do with Rails.  <a href="https://pragprog.com/book/jvrails2/crafting-rails-4-applications">Crafting Rails 4 Applications</a> is the best resource I&#39;ve found to get a sense of what is possible, but when I sat down to work on something there was a lot of trial and error.  They through how they created <a href="https://github.com/plataformatec/mail_form">mail_form</a>, or at least a simplified version of it, that lets you use rails validations from ActiveRecord without having to back up the model with a database.  (As you might infer from the name, something that is useful for Contact forms that send out email.)  The book also goes through how Rails Engines work, which are very much like rails plugins but with additional integration points into the rails application lifecycle.</p>
        </div>
      </div>
      <div class="row article_footer">
        <div class="comments">
          December  7, 2014
          <a href="#" id="comment_shower">
            <span class="socicon socicon-disqus fgcolor"></span>
            <span class="disqus-comment-count" data-disqus-identifier="2014-12-07-dateslice-writing-rails-extensions.html">Be the first to comment.</span>
          </a>
        </div>
        <div class="sharing">
          <a href="http://www.twitter.com/share?url=http://willschenk.com//dateslice-writing-rails-extensions/&amp;text=Dateslice: Writing rails extensions by @wschenk" title="Share this post on Twitter" data-lang="en" onclick="return !window.open(this.href, 'Twitter', 'width=640,height=300')"><span class="socicon socicon-twitter fgcolor"></span></a>
      
          <a target="_blank" onclick="return !window.open(this.href, 'Facebook', 'width=640,height=300')" href="http://www.facebook.com/sharer/sharer.php?u=http://willschenk.com//dateslice-writing-rails-extensions/" title="Share this post on Facebook"><span class="socicon socicon-facebook fgcolor"></span></a>
      
          <a href="http://plus.google.com/share?url=http://willschenk.com//dateslice-writing-rails-extensions/" target="_blank" onclick="return !window.open(this.href, 'Google +', 'width=640,height=300')" title="Share this post on Google +"><span class="socicon socicon-google fgcolor"></span></a>
        </div>
      </div>
      <div class="row comment_universe">
        <div id="disqus_thread" class="col-sm-10 col-sm-offset-1"></div>
      </div>
      
      
        <div class="row navigation">
          <div class="before">
              <h3>Earlier posts</h3>
                <p>Chronological, Ruby: <a href="/new-happyseed-released/">New HappySeed released</a></p>
                <p>Howto: <a href="/building-sites-with-middleman/">Building Sites with Middleman</a></p>
          </div>
      
          <div class="after">
          </div>
        </div>
    </div>
    <footer class='footer lighter dark_header'>
      <ul class='nav nav-pills header_links'>
        <li><a href="/">Articles</a></li>
        <!-- %li= link_to "About", "/about.html" -->
        <li><a href="/tags/overview/">Compleat</a></li>
        <li><a href="/tags/howto/">Howto</a></li>
        <li><a href="/tags/socialinvestigator/">Socialinvestigator</a></li>
        <li><a href="http://happyfuncorp.com">HappyFunCorp</a></li>
        <li><a href="/feed.xml">RSS</a></li>
      </ul>
      <p>
        You can also find me on
        <a href='http://twitter.com/wschenk'>
          Twitter,
        </a>
        <a href='http://sublimeguile.com/'>
          Tumblr,
        </a>
        <a href='http://instagram.com/wschenk'>
          Instagram,
        </a>
        <a href='http://www.linkedin.com/pub/will-schenk/0/266/420/'>
          Linkedin,
        </a>
        <a href='https://github.com/wschenk'>
          Github,
        </a>
        or on
        <a href='mailto: will@happyfuncorp.com'>Email.</a>
      </p>
      <p class='social'>
        <a href='http://twitter.com/wschenk'>
          <span class='socicon socicon-twitter bgcolor'></span>
        </a>
        <a href='http://sublimeguile.com/'>
          <span class='socicon socicon-tumblr bgcolor'></span>
        </a>
        <a href='http://instagram.com/wschenk'>
          <span class='socicon socicon-instagram bgcolor'></span>
        </a>
        <a href='http://www.linkedin.com/pub/will-schenk/0/266/420/'>
          <span class='socicon socicon-linkedin bgcolor'></span>
        </a>
        <a href='https://github.com/wschenk'>
          <span class='socicon socicon-github bgcolor'></span>
        </a>
      </p>
    </footer>
    <script src="../javascripts/application-f8812046.js" type="text/javascript"></script> <!-- #, 'mermaid.full.min' %> -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/highlight.min.js"></script>
    <script type="text/javascript">
      hljs.initHighlightingOnLoad();
    
      $(".article img").addClass( "img-responsive");
    
      $("iframe").map( function(e) {
        $(this).css( "max-width", $(this).width() );
        $(this).width( "100%" );
    
      });
    
      var _gaq=[['_setAccount','UA-56296045-1'],['_trackPageview']];
      (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
      g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
      s.parentNode.insertBefore(g,s)}(document,'script'));
    
      var disqus_shortname = 'willschenk';
        var disqus_identifier = '2014-12-07-dateslice-writing-rails-extensions.html';
            
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    
      (function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
  </body>
</html>
